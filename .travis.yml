language: python
branches:
  only:
  - develop
  - master
addons:
  apt:
    packages:
    - gfortran
    - flex
    - bison

env:
  global:
  - CIBW_BUILD: cp3?-*
  - CIBW_TEST_COMMAND: python3 -m unittest discover tests
  - CIBW_TEST_REQUIRES: ddt
  - TWINE_USERNAME: __token__

jobs:
  include:
  - services: docker
    language: shell
    env:
    - CIBW_BEFORE_BUILD: "yum install -y flex bison libxml2-devel zlib-devel && python3 setup.py build_c_core && python3 setup.py sdist"
    before_install:
    - sudo apt-get update
    - sudo apt-get -y install python3 python3-pip
    - python3 -m pip install --upgrade pip
    - python3 -m pip install setuptools
  - os: osx
    language: shell
    env:
    - CIBW_BEFORE_BUILD="python3 setup.py build_c_core"
notifications:
  email:
    on_success: change
    on_failure: always

install:
  - python3 -m pip install twine cibuildwheel==1.3.0

script:
  # build the wheels, put them into './wheelhouse'
  - python3 -m cibuildwheel --output-dir wheelhouse

 after_success:
   - if [[ $TRAVIS_TAG ]]; then python3 -m twine upload wheelhouse/*.whl; fi